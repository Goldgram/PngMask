/**
 * PngMask Class
 */var _PngMask=function(e,t,n){function o(e){return e.complete&&e.naturalHeight!==0}function u(e){var t=document.createElement("canvas");t.width=e.width;t.height=e.height;t.getContext("2d").drawImage(e,0,0,e.width,e.height);r.imageVars[e.relativeSrc].canvasContext=t.getContext("2d")}function a(e,t){var n=r.imageVars[e.relativeSrc].canvasContext.getImageData(t.x,t.y,1,1).data[3];return n>r.alphaTolerance}function f(e,t){switch(t){case"topLeft":return e.x+" "+e.y+" ";case"bottomLeft":return e.x+" "+(e.y+r.mappingTolerance)+" ";case"topRight":return e.x+r.mappingTolerance+" "+e.y+" ";case"bottomRight":return e.x+r.mappingTolerance+" "+(e.y+r.mappingTolerance)+" "}}function l(e,t){var n=i[t].x*r.mappingTolerance,s=i[t].y*r.mappingTolerance;return{x:e.x+n,y:e.y+s}}function c(e,t){r.imageVars[e.relativeSrc].paths[r.imageVars[e.relativeSrc].pathIndex]+=t}function h(e,t,n){var i,o=s[n],u=l(t,o.straight);if(!a(e,u))i=[t,o.rightCorner,o.rightString];else{var h=l(t,o.left);a(e,h)?i=[h,o.leftCorner,o.leftString]:i=[u,o.straightCorner,n]}var p=f(i[0],i[1]);if(p===r.imageVars[e.relativeSrc].startingPath)return{status:"complete"};c(e,"L"+p);return{node:i[0],dir:i[2]}}function p(){var e="#",t="0123456789ABCDEF".split("");e+=t[t.length-1-Math.round(Math.random()*4)];for(var n=0;n<5;n++)e+=t[Math.floor(Math.random()*t.length)];return e}function d(e){var t=document.createElement("style");t.setAttribute("id","png-mask-style");t.type="text/css";var n="",i=document.createElementNS("http://www.w3.org/2000/svg","svg");for(var s=0;s<e.attributes.length;s++){var o=e.attributes[s].nodeName,u=e.attributes[s].nodeValue;o!=="src"&&i.setAttribute(o,u)}var a=i.getAttribute("class"),f="png-mask-svg";r.elementAttributes.class&&(f+=" "+r.elementAttributes.class);i.setAttribute("class",a?a+" "+f:f);i.setAttribute("width",e.width+"px");i.setAttribute("height",e.height+"px");n+=".png-mask-svg {pointer-events:none;}";i.setAttribute("viewBox","0 0 "+e.width+" "+e.height+"");i.setAttribute("xmlns","http://www.w3.org/2000/svg");var l=document.createElementNS("http://www.w3.org/2000/svg","image");l.setAttribute("class","png-mask-image");l.setAttribute("height",e.height);l.setAttribute("width",e.width);l.setAttribute("href",e.getAttribute("src"));l.setAttribute("x","0");l.setAttribute("y","0");n+=".png-mask-image {pointer-events:none;}";var c="";for(var h=0;h<r.imageVars[e.relativeSrc].paths.length;h++)c+=r.imageVars[e.relativeSrc].paths[h]+"Z ";var d=document.createElementNS("http://www.w3.org/2000/svg","path");d.setAttribute("class","png-mask-path");d.setAttribute("d",c);if(r.debug.on){d.setAttribute("fill",p());d.setAttribute("fill-opacity",.75);n+=".png-mask-path:hover {fill-opacity:0.25;}"}else d.setAttribute("fill","transparent");n+=".png-mask-path {cursor:pointer;pointer-events:auto;}";if(r.maskOrShadow==="mask"){i.appendChild(l);i.appendChild(d)}else if(r.maskOrShadow==="shadow"){i.appendChild(d);i.appendChild(l)}if(!document.getElementById("png-mask-style")){t.appendChild(document.createTextNode(n));document.head.appendChild(t)}return i}function v(e,t){for(var n=0;n<r.imageVars[e.relativeSrc].paths.length;n++){var i=r.imageVars[e.relativeSrc].paths[n];if(i.indexOf(t)>-1)return!0}return!1}function m(e){r.imageVars[e.relativeSrc]={startingPath:"",pathIndex:0,paths:[]};u(e);var t=Math.floor(e.height/(r.searchTolerance+1));for(var n=1;n<=r.searchTolerance;n++){var i=n*t,s=!1,o={x:0,y:i};while(o.x<e.width){if(a(e,o)!==s){var l=o;s&&l.x--;var p=f(l,s?"topRight":"bottomLeft");if(!v(e,p)){r.imageVars[e.relativeSrc].startingPath=p;r.imageVars[e.relativeSrc].paths[r.imageVars[e.relativeSrc].pathIndex]="M"+p;c(e,"L"+f(l,s?"bottomRight":"topLeft"));var d={node:l,dir:s?"down":"up"};while(d.status!=="complete")d=h(e,d.node,d.dir);r.imageVars[e.relativeSrc].startingPath="";r.imageVars[e.relativeSrc].pathIndex++}s=!s;if(!r.multiplePaths)break}o.x++}}return r.imageVars[e.relativeSrc].paths.length>0}function g(e){return e instanceof HTMLImageElement}function y(e,t){return new Promise(function(n,i){setTimeout(function(){if(o(e)){if(!m(e))return i("image has no alpha above the tolerance: "+e);r.masksBySrc[e.relativeSrc]=d(e);if(r.debug.on){r.debug.completeCount++;console.log(e.relativeSrc+" mask calculated ("+r.debug.completeCount+" of "+Object.keys(r.masksBySrc).length+")")}return n(e.relativeSrc)}return y(e,100)},t)})}var r=this,i=[{x:-1,y:-1},{x:0,y:-1},{x:1,y:-1},{x:1,y:0},{x:1,y:1},{x:0,y:1},{x:-1,y:1},{x:-1,y:0}],s={up:{left:0,leftCorner:"bottomLeft",leftString:"left",straight:1,straightCorner:"topLeft",rightCorner:"topRight",rightString:"right"},right:{left:2,leftCorner:"topLeft",leftString:"up",straight:3,straightCorner:"topRight",rightCorner:"bottomRight",rightString:"down"},down:{left:4,leftCorner:"topRight",leftString:"right",straight:5,straightCorner:"bottomRight",rightCorner:"bottomLeft",rightString:"left"},left:{left:6,leftCorner:"bottomRight",leftString:"down",straight:7,straightCorner:"bottomLeft",rightCorner:"topLeft",rightString:"up"}};this.multiplePaths=t&&t.multiplePaths||!1;this.mappingTolerance=t&&t.mappingTolerance||2;this.alphaTolerance=t&&t.alphaTolerance||80;this.searchTolerance=t&&t.searchTolerance||1;this.elementAttributes=t&&t.elementAttributes||{};this.maskOrShadow=t&&t.mask?"mask":"shadow";t&&t.replaceImage?this.replaceImage=!0:this.replaceImage=n&&n.replaceImage||!1;this.debug={on:t&&t.debug||!1,completeCount:0};this.imageVars={};this.masksBySrc={};var b=new Promise(function(t,n){var i=[];for(var s=0;s<e.length;s++){var o,u=e[s];if(!g(u))return n("element is not an image: "+u);u.relativeSrc=u.getAttribute("src");if(!r.masksBySrc[u.relativeSrc]){r.masksBySrc[u.relativeSrc]={};o=y(u,0)}else o=new Promise(function(e){return e(u.relativeSrc)});i.push(o)}return Promise.all(i).then(function(n){if(r.replaceImage)for(var i=e.length-1;i>=0;i--){var s=r.masksBySrc[n[i]].cloneNode(!0),o=e[i];e[i].parentNode.replaceChild(s,o)}return t(r.masksBySrc)},function(e){return n(e)})});r.debug.on&&b.then(function(e){console.log("Complete:");console.log(e)},function(e){console.log("Error: "+e)});return b},pngMaskByImage=function(e,t){if(!e)return Promise.reject("cannot find image: "+e);var n=document.createElement("img");n.src=e;var r=[n],i=new _PngMask(r,t);return Promise.resolve(i)},pngMaskByImages=function(e,t){if(!e||!e.length)return Promise.reject("cannot find images: "+e);var n=[];for(var r=0;r<e.length;r++){var i=document.createElement("img");i.src=e[r];n.push(i)}var s=new _PngMask(n,t);return Promise.resolve(s)},pngMaskById=function(e,t){var n=document.getElementById(e);if(!n)return Promise.reject("cannot find id: "+e);var r=[n],i=new _PngMask(r,t,{replaceImage:!0});return Promise.resolve(i)},pngMaskByClass=function(e,t){var n=document.getElementsByClassName(e);if(!n.length)return Promise.reject("cannot find class: "+e);var r=new _PngMask(n,t,{replaceImage:!0});return Promise.resolve(r)},pngMaskByElement=function(e,t){},pngMaskByElements=function(e,t){};typeof jQuery!="undefined"&&function(e){e.fn.pngMask=function(e){if(this.length){var t=new _PngMask(this,e,{replaceImage:!0});return Promise.resolve(t)}return Promise.reject("elements are undefined")}}(jQuery);